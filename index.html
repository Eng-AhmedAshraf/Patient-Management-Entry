<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <link rel="stylesheet" href="Styles/Index.css">
  </head>

  <body>
    <div class="login-container">
      <h2>Login</h2>

      <form id="loginForm" onsubmit="event.preventDefault(); loginUser();">
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" />
          <span class="error" id="emailError"></span>
        </div>

        <div class="form-group">
          <label for="password">Password</label>
          <div class="password-container">
            <input id="password" type="password" autocomplete="new-password" />
            <button type="button" class="toggle-password" data-target="password" aria-label="Show password">
              <!-- Eye icon -->
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </button>
          </div>
          <span class="error" id="passwordError"></span>
        </div>


        <button type="submit" class="btn">Login</button>
      </form>

      <div class="link">
        Don't have an account? <a href="Register.html">Register here</a>
      </div>

      <div class="forgot-password">
        <a href="#" onclick="resetPassword()">Forgot Password?</a>
      </div>

      <span class="error" id="resetError"></span>
      <span id="resetSuccess"></span>


      <div id="loginError"></div>
      <div id="successMsg"></div>
    </div>

    <!-- Firebase (compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyD63tKW59G9o7PDA6UmAiCJVYG4EQsImy4",
        authDomain: "patient-data-8e9df.firebaseapp.com",
        projectId: "patient-data-8e9df",
        storageBucket: "patient-data-8e9df.firebasestorage.app",
        messagingSenderId: "221770876835",
        appId: "1:221770876835:web:47750c283c244ab2347c16",
        measurementId: "G-6RS0ENTL2Y"
      };

      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();

      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      const eyeSvg = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>`;
      const eyeOffSvg = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-7 0-11-7-11-7a20.8 20.8 0 0 1 5.22-6.16"/><path d="M1 1l22 22"/></svg>`;

      document.querySelectorAll('.toggle-password').forEach(btn=>{
        btn.addEventListener('click', () => {
          const targetId = btn.dataset.target;
          const input = document.getElementById(targetId);
          if (!input) return;
          if (input.type === 'password') {
            input.type = 'text';
            btn.innerHTML = eyeOffSvg;
            btn.setAttribute('aria-pressed','true');
          } else {
            input.type = 'password';
            btn.innerHTML = eyeSvg;
            btn.setAttribute('aria-pressed','false');
          }
        });
      });

      async function loginUser() {
        document.getElementById("emailError").textContent = "";
        document.getElementById("passwordError").textContent = "";
        document.getElementById("loginError").textContent = "";
        document.getElementById("successMsg").textContent = "";

        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;

        let valid = true;

        if (!email) {
          document.getElementById("emailError").textContent = "Email is required";
          valid = false;
        } else if (!emailPattern.test(email)) {
          document.getElementById("emailError").textContent = "Enter a valid email address";
          valid = false;
        }

        if (!password) {
          document.getElementById("passwordError").textContent = "Password is required";
          valid = false;
        } else if (password.length < 6) {
          document.getElementById("passwordError").textContent = 
            "Password must be 8+ chars, include upper, lower, number, and special (!@#$%^&*)";
          valid = false;
        }

        if (!valid) return;

        try {
          await auth.signInWithEmailAndPassword(email, password);
          document.getElementById("successMsg").textContent = "Login successful!";
          setTimeout(() => {
            window.location.href = "Main.html"; 
          }, 1200);
        } catch (error) {
          document.getElementById("loginError").textContent = "Your Email or Password is Incorrect";
        }
      }

      async function resetPassword() {
        document.getElementById('resetError').textContent = "";
        document.getElementById('resetSuccess').textContent = "";

        const email = document.getElementById('email').value.trim();

        if (!email) {
          document.getElementById('resetError').textContent = "Please enter your email first";
          return;
        }

        try {
          await firebase.auth().sendPasswordResetEmail(email);
          document.getElementById('resetSuccess').textContent = "Password reset email sent!";
        } catch (error) {
          document.getElementById('resetError').textContent = error.message;
        }
      }
    </script>
  </body>
</html>